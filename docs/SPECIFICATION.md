# miniRT 仕様書

## 概要

miniRTは、レイトレーシング技術を使用してコンピュータ生成画像をレンダリングするプログラムです。MiniLibXライブラリを使用してウィンドウ管理とピクセル描画を行います。

---

## 1. プログラム仕様

| 項目 | 内容 |
|------|------|
| プログラム名 | `miniRT` |
| 引数 | `*.rt`形式のシーン記述ファイル |
| 使用言語 | C言語 |
| コンパイラフラグ | `-Wall -Wextra -Werror` |

### 1.1 使用可能な外部関数

- 標準関数: `open`, `close`, `read`, `write`, `printf`, `malloc`, `free`, `perror`, `strerror`, `exit`
- 数学ライブラリ: `math.h`の全関数（`-lm`フラグでコンパイル）
- グラフィックス: MiniLibXライブラリの全関数
- その他: `gettimeofday()`

### 1.2 自作ライブラリ

- `libft`: 許可

---

## 2. 機能要件

### 2.1 幾何学的オブジェクト

以下の3種類のオブジェクトをサポートする:

| オブジェクト | 識別子 | プロパティ |
|-------------|--------|-----------|
| 球 (Sphere) | `sp` | 中心座標、直径、色 |
| 平面 (Plane) | `pl` | 通過点座標、法線ベクトル、色 |
| 円柱 (Cylinder) | `cy` | 中心座標、軸ベクトル、直径、高さ、色 |

### 2.2 ライティング

| 種類 | 説明 |
|------|------|
| 環境光 (Ambient) | シーン全体に均一に適用される基底光 |
| 拡散光 (Diffuse) | 光源からの方向依存の照明 |
| ハードシャドウ | オブジェクトによる影の描画 |

### 2.3 交差判定

- 全てのオブジェクトに対するレイとの交差を正しく処理
- オブジェクト内部からの交差も正しく処理

### 2.4 変換

| 変換 | 対象オブジェクト |
|------|------------------|
| 平行移動 | 全オブジェクト、ライト、カメラ |
| 回転 | 平面、円柱、カメラ（球とライトは回転不可） |
| リサイズ | 球の直径、円柱の幅と高さ |

---

## 3. ウィンドウ管理

### 3.1 表示仕様

| 項目 | 値 |
|------|-----|
| ウィンドウ幅 | 1080px |
| ウィンドウ高さ | 800px |

### 3.2 操作

| 操作 | 動作 |
|------|------|
| ESCキー押下 | ウィンドウを閉じ、プログラムを正常終了 |
| ウィンドウの×ボタン | ウィンドウを閉じ、プログラムを正常終了 |
| ウィンドウ切り替え | 流動的に動作すること |
| 最小化 | 流動的に動作すること |

---

## 4. シーンファイル形式 (`.rt`)

### 4.1 基本ルール

- ファイル拡張子: `.rt`
- 要素は1つ以上の改行で区切る
- 要素内の情報は1つ以上のスペースで区切る
- 要素の順序は任意
- 大文字識別子の要素（A, C, L）はシーン内で1回のみ

### 4.2 要素定義

#### 環境光 (Ambient Light)

```
A <ratio> <R,G,B>
```

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| 識別子 | `A` | 固定 |
| ratio | 0.0〜1.0 | 環境光の強度 |
| R,G,B | 0〜255 | 色（カンマ区切り） |

**例:** `A 0.2 255,255,255`

#### カメラ (Camera)

```
C <x,y,z> <dx,dy,dz> <FOV>
```

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| 識別子 | `C` | 固定 |
| x,y,z | 実数 | 視点座標 |
| dx,dy,dz | -1.0〜1.0 | 正規化方向ベクトル |
| FOV | 0〜180 | 水平視野角（度） |

**例:** `C -50.0,0,20 0,0,1 70`

#### ライト (Light)

```
L <x,y,z> <brightness> <R,G,B>
```

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| 識別子 | `L` | 固定 |
| x,y,z | 実数 | ライト座標 |
| brightness | 0.0〜1.0 | 明るさ |
| R,G,B | 0〜255 | 色（必須パートでは未使用） |

**例:** `L -40.0,50.0,0.0 0.6 10,0,255`

#### 球 (Sphere)

```
sp <x,y,z> <diameter> <R,G,B>
```

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| 識別子 | `sp` | 固定 |
| x,y,z | 実数 | 中心座標 |
| diameter | 正の実数 | 直径 |
| R,G,B | 0〜255 | 色 |

**例:** `sp 0.0,0.0,20.6 12.6 10,0,255`

#### 平面 (Plane)

```
pl <x,y,z> <nx,ny,nz> <R,G,B>
```

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| 識別子 | `pl` | 固定 |
| x,y,z | 実数 | 平面上の点 |
| nx,ny,nz | -1.0〜1.0 | 正規化法線ベクトル |
| R,G,B | 0〜255 | 色 |

**例:** `pl 0.0,0.0,-10.0 0.0,1.0,0.0 0,0,225`

#### 円柱 (Cylinder)

```
cy <x,y,z> <ax,ay,az> <diameter> <height> <R,G,B>
```

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| 識別子 | `cy` | 固定 |
| x,y,z | 実数 | 中心座標 |
| ax,ay,az | -1.0〜1.0 | 正規化軸ベクトル |
| diameter | 正の実数 | 直径 |
| height | 正の実数 | 高さ |
| R,G,B | 0〜255 | 色 |

**例:** `cy 50.0,0.0,20.6 0.0,0.0,1.0 14.2 21.42 10,0,255`

### 4.3 サンプルシーン

```
A    0.2                                   255,255,255

C    -50,0,20        0,0,1       70
L    -40,0,30                    0.7       255,255,255

pl   0,0,0           0,1.0,0               255,0,225
sp   0,0,20                      20        255,0,0
cy   50.0,0.0,20.6   0,0,1.0     14.2 21.42 10,0,255
```

---

## 5. エラー処理

### 5.1 エラー出力形式

```
Error
<エラーメッセージ>
```

### 5.2 検出すべきエラー

| カテゴリ | エラー内容 |
|---------|-----------|
| 引数 | ファイル拡張子が`.rt`でない |
| 引数 | ファイルが存在しない/読めない |
| 構文 | 不明な識別子 |
| 構文 | パラメータ数の不一致 |
| 値 | 範囲外の値（ratio, FOV, 色など） |
| シーン | 必須要素（A, C, L）の欠落 |
| シーン | 大文字要素の重複定義 |
| シーン | オブジェクトが1つもない |

---

## 6. 技術仕様

### 6.1 座標系

- 右手座標系
- X軸: 右方向が正
- Y軸: 上方向が正
- Z軸: 手前方向が正

### 6.2 定数

| 定数 | 値 | 用途 |
|------|-----|------|
| EPSILON | 1e-6 | 浮動小数点比較の許容誤差 |
| PI | 3.14159265358979323846 | 円周率 |

### 6.3 レンダリングアルゴリズム

1. **カメラフレーム設定**: FOVに基づく視錐台の計算
2. **レイ生成**: 各ピクセルに対応するレイを生成
3. **交差判定**: 全オブジェクトとの交差を計算
4. **最近接点選択**: 最も近い交差点を選択
5. **シャドウレイ**: 光源への遮蔽を判定
6. **シェーディング**: 環境光 + 拡散光を計算
7. **色出力**: ピクセル色を決定

---

## 7. ボーナス機能（オプション）

必須パートが完全に動作する場合のみ実装可能:

| 機能 | 説明 |
|------|------|
| スペキュラ反射 | 完全なPhong反射モデル |
| チェッカーボード | パターンテクスチャ |
| 複数ライト | 色付きマルチスポットライト |
| 追加オブジェクト | 円錐、双曲面、放物面など |
| バンプマッピング | テクスチャによる法線操作 |

---

## 8. ビルド仕様

### 8.1 Makefileルール

| ルール | 動作 |
|--------|------|
| `all` | プログラムをビルド |
| `clean` | オブジェクトファイルを削除 |
| `fclean` | オブジェクトファイルと実行ファイルを削除 |
| `re` | `fclean` + `all` |
| `bonus` | ボーナス機能付きでビルド |

### 8.2 プラットフォーム

- macOS
- Linux

---

## 9. プロジェクト構成

```
miniRT/
├── includes/           # ヘッダファイル
│   ├── miniRT.h       # メインAPI
│   ├── struct.h       # データ構造定義
│   ├── config.h       # 設定定数
│   └── errors.h       # エラーメッセージ
├── srcs/              # ソースコード
│   ├── main.c         # エントリポイント
│   ├── init.c         # 初期化
│   ├── mlx.c          # ウィンドウ管理
│   ├── render.c       # レイトレーシング
│   ├── render_shading.c # シェーディング
│   ├── ray_*.c        # 交差判定
│   ├── parsing/       # パーシング
│   ├── utils/         # ユーティリティ
│   └── debug/         # デバッグ用
├── libft/             # 自作ライブラリ
├── minilibx_*/        # MiniLibXライブラリ
├── scenes/            # テストシーン
│   ├── valid/         # 正常系テスト
│   └── error/         # 異常系テスト
└── Makefile
```

---

## 10. 実装状況

### 10.1 必須パート

| 機能 | 状態 |
|------|------|
| シーンパーシング | 完了 |
| 球の交差判定 | 完了 |
| 平面の交差判定 | 完了 |
| 円柱の交差判定 | 完了 |
| 環境光 | 完了 |
| 拡散光 | 完了 |
| シャドウ | 完了 |
| ウィンドウ管理 | 完了 |
| エラー処理 | 完了 |

### 10.2 ボーナスパート

| 機能 | 状態 |
|------|------|
| スペキュラ反射 | 未実装 |
| チェッカーボード | 未実装 |
| 複数ライト | 未実装 |
| 追加オブジェクト | 未実装 |
| バンプマッピング | 未実装 |

---

## 付録A: 数学公式

### A.1 レイの定義

```
P(t) = O + t * D
```

- O: レイの原点
- D: レイの方向（正規化）
- t: パラメータ（t > 0で有効）

### A.2 球との交差

球の方程式: `|P - C|² = r²`

二次方程式: `at² + bt + c = 0`
- a = D · D
- b = 2 * D · (O - C)
- c = (O - C) · (O - C) - r²

判別式: `Δ = b² - 4ac`

### A.3 平面との交差

平面の方程式: `(P - P₀) · N = 0`

```
t = (P₀ - O) · N / (D · N)
```

- P₀: 平面上の点
- N: 法線ベクトル

### A.4 円柱との交差

側面、上面キャップ、下面キャップの3つの交差を個別に計算し、最も近い有効な交差点を選択。

### A.5 拡散光（ランバート反射）

```
I_diffuse = I_light * k_d * max(0, N · L)
```

- I_light: 光源の強度
- k_d: 拡散反射係数
- N: 表面法線
- L: 光源方向

---

*最終更新: 2026-01-10*
