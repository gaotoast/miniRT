name: Build Test
run-name: Build test for ${{ github.event.pull_request.head.ref }}

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxext-dev zlib1g-dev valgrind xvfb

      - name: Clone minilibx-linux
        run: git clone https://github.com/42Paris/minilibx-linux.git

      - name: Build project
        run: make all

      - name: Verify binary exists
        run: |
          test -f miniRT
          echo "Build successful: miniRT created"

      - name: Valgrind test with valid scenes
        run: |
          for scene in scenes/valid/*.rt; do
            echo "Testing: $scene"
            timeout 3 xvfb-run -a valgrind --leak-check=full --errors-for-leak-kinds=all --error-exitcode=42 ./miniRT "$scene" || code=$?
            if [ "${code:-0}" -eq 42 ]; then
              echo "Memory leak detected in $scene"
              exit 1
            fi
            echo "OK: $scene"
          done
